<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Incremental solutions to jamming</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="about.html">About</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="1-impacts.html"><strong aria-hidden="true">1.</strong> The impacts of channel jamming</a></li><li class="chapter-item expanded "><a href="2-costs.html"><strong aria-hidden="true">2.</strong> Channel jamming costs</a></li><li class="chapter-item expanded "><a href="3-incremental_solutions.html" class="active"><strong aria-hidden="true">3.</strong> Incremental solutions to jamming</a></li><li class="chapter-item expanded "><a href="4-design_space.html"><strong aria-hidden="true">4.</strong> Solution Design space</a></li><li class="chapter-item expanded "><a href="5-advanced_upfront.html"><strong aria-hidden="true">5.</strong> Advanced Upfront Fee (hold-time)</a></li><li class="chapter-item expanded "><a href="6-reputation.html"><strong aria-hidden="true">6.</strong> Reputation Scheme (SC+FP)</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="grand-conclusion.html">Subjective Grand Conclusion</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="incremental-solutions-to-channel-jamming"><a class="header" href="#incremental-solutions-to-channel-jamming">Incremental solutions to channel jamming</a></h1>
<h2 id="intro"><a class="header" href="#intro"><strong>Intro</strong></a></h2>
<p>In previous chapters, we demonstrated what can be achieved with jamming, and at what cost.</p>
<p>Now, we will overview some straightforward ideas for reducing the attack efficiency without significant protocol modifications (or even deployed by node operators individually).</p>
<p>More specifically, we focus on preventing slot jamming, which makes the attack so cheap. These solutions could presumably force an attacker to use amount jamming instead, which we demonstrate is more expensive.</p>
<h2 id="solution-1-jit-transaction-staging"><a class="header" href="#solution-1-jit-transaction-staging"><strong>Solution 1: JIT Transaction Staging</strong></a></h2>
<p>Slot jamming is possible because it is not secure for one channel to carry more than 483 in-flight HTLCs in a given direction, since exceeding it would make a commitment transaction too large and invalid.</p>
<p>Payment channel structure could be changed to bypass this bound by using a tree of commitments. Two-staged transaction construction would allow raising the HTLC limit to <code>483 * 483 = 233,289 slots</code>.</p>
<p>On itself, this solution is not an improvement, because an attacker would get the same benefit as the victim. It could even make an attacker more advantageous, if they use this optimization while victims don’t.</p>
<p>However, this technique <em>could</em> enhance other Slot Bucketing defence, which we present later in this chapter.</p>
<p>This solution also comes with the following disadvantages:</p>
<ul>
<li>force-closing becomes 483 times more expensive (in the worst case)</li>
<li>safety timelocks should be expanded considering that two transactions have to be confirmed (slightly reducing funds velocity)</li>
<li>it requires substantial changes to the LN software critical subsystems (which were subject to funds-loss bugs <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2022-April/003561.html">previously</a>)</li>
</ul>
<h2 id="solution-2-active-defense"><a class="header" href="#solution-2-active-defense"><strong>Solution 2: Active defense</strong></a></h2>
<p>Once the jamming is detected, a victim could open more channels, so that their operations are not disrupted. While this could limit the harm w.r.t. merchant activities, opportunity losses in terms of the locked capital remain.</p>
<p>At the same time, nothing prevents an attacker from jamming these newly created channels, resulting in a liquidity competition between an attacker and a victim. If there is a capital asymmetry in favor of the attacker, this protection is inefficient.</p>
<h2 id="solution-3-slot-bucketing"><a class="header" href="#solution-3-slot-bucketing"><strong>Solution 3: Slot bucketing</strong></a></h2>
<p>The root cause of the slot jamming attacks is the limitation on the number of HTLC slots for payment forwarding on every channel, especially when all slots are “equal” in terms of the payment amount.</p>
<p><a href="https://github.com/lightning/bolts/issues/873">Splitting the payments into amount-based buckets</a> so that jamming high-volume payments at least requires locking an adequate amount may improve on this issue. Lower buckets should be allowed for high-value payments, but not the way around.</p>
<p align="center" width="100%">
    <img width="66%" src="pics/buckets.png">
    <br />
    <i>Bucket structure</i>
</p>
<p>The jamming cost (of higher amount ranges) then becomes significantly higher, often to the point where it’s cheaper to apply amount jamming instead. The ultimate disadvantage of bucketing is a <strong>cheaper cost of attacking payments from the lower buckets</strong> because an attacker can apply slot jamming with fewer channels.</p>
<p>In this case, an efficient attack strategy would be slot jamming buckets one-by-one, starting with the lower buckets. This is equivalent to amount jamming several channels, capacity of which equals <em>slots * lower_bound.</em></p>
<p>It remains debatable whether LN ecosystem should strive to support low-value payments at the cost of lower security of high-value payments. Low-value payments could be valuable for the public image (micropayments) and facilitate selling granular digital services (API requests, streaming data, etc.). Ultimately, this could be decided by every routing node.</p>
<p><em>We leave evaluating how this method works in practice for further research. The first iteration of this idea <a href="https://github.com/ACINQ/eclair/pull/2330">in Eclair</a> could be used to provide initial insights.</em></p>
<p><strong>Payments below dust and 0-bucket policy</strong></p>
<p>A special cast of bucketing is handling below-dust HTLC values separately. Since these HTLCs could not be confirmed on-chain, applying the slot limits to them is meaningless in the first place. We advice routing nodes to keep a “0 bucket” not consuming slots from other payments.</p>
<p>By updating the measurements from the previous chapters, this method could easily increase the opportunity cost aspect of slot jamming (with looping) above-dust payments to:</p>
<p><code>opportunity_cost (N) = T * interest_rate * (N * 473 / 6) * dust_limit = T * interest_rate * N * 43043 (sats)</code>,</p>
<p>assuming the <code>dust_limit=546 sats</code> for simplicity (although it <a href="https://github.com/lightning/bolts/blob/master/03-transactions.md#dust-limits">could be negotiated differently</a>).</p>
<p>The size of “0 bucket” would be upper-bounded by two other parameters:</p>
<ul>
<li>”how much a routing node can afford to lose from this HTLC forward risk”</li>
<li>CPU/memory requirements to handle many in-flight HTLCs and prevent DoS</li>
</ul>
<h2 id="targeted-attack-cost"><a class="header" href="#targeted-attack-cost"><strong>Targeted attack cost</strong></a></h2>
<p>Now, let’s discuss the attack costs once 0-bucketing and/or slot bucketing is implemented.</p>
<p>First, we need to evaluate the cost of amount jamming, as it will be involved in further calculations.</p>
<h3 id="amount-jamming-cost"><a class="header" href="#amount-jamming-cost">Amount jamming cost</a></h3>
<p>The cost of opening N channels remains the same:</p>
<p><code>opening_cost = (N * 34 + 122) vbytes * 1sat/vbyte = 34 N + 122 (sats)</code></p>
<p>Notably, N for amount jamming would be lower, because an attacker is not limited by the 1-to-1 (or 1-to-20) attacker-victim ratio of HTLC slots.</p>
<p>The opportunity cost, in turn, could be computed as follows:</p>
<p><code>opportunity_cost = T * (base_amount + base_amount * routing_percent_fee * hops) * interest_rate</code></p>
<p>Since the percent_fee equals 0.032% (<a href="https://assets.ctfassets.net/4rilomtvvae4/4Q8jnXMVUDMovAY8hcpYkL/fb65b3290c8dcb23314aacb6f9b19be6/The_State_of_Lightning_Vol_2.pdf">Arcane Research</a>, page 19) and <strong>not accounting for the locking duration</strong>, the routing fee addendum can be dropped, and the opportunity cost could be reduced to the interest of using <em>base_amount</em>.</p>
<p><strong>A highlight of these equations is that the opportunity cost component becomes a dominant factor, and the attack cost becomes mainly dependent on the target capacity.</strong></p>
<h3 id="slot-jamming-0-bucket-vs-amount-jamming"><a class="header" href="#slot-jamming-0-bucket-vs-amount-jamming">Slot jamming 0-bucket vs. amount jamming</a></h3>
<p>First, let’s see under which conditions just implementing a 0-bucket would make the cost higher than the amount jamming cost. We have to solve the following inequation.</p>
<p><code>slot_jamming_cost &gt;= amount_jamming_cost</code> ⇒</p>
<p><code>34 * N1 + 122 + T * interest_rate * N1 * 43044 &gt; 34 * N2 + 122 + T * interest_rate * base_amount</code> ⇒</p>
<p><code>34 * (N1 - N2) &gt; T * interest_rate * (base_amount - N1 * 43044)</code> ⇒</p>
<p><code>N1 - N2 &gt; T * interest_rate * (base_amount - N1 * 43044) / 34</code></p>
<p>For example, if a single channel is targeted (N1=N2=1):</p>
<p><code>0 &gt; T * interest_rate * (base_amount - 43044) / 34</code> ⇒</p>
<p><code>base_amount &lt; 43044 (sats).</code></p>
<p>In other words, attacking one bucketed channel with less than 43044 sats makes amount jamming more efficient.</p>
<p>Alternatively, if 11 channels are targeted (N1 = 11, N2 = 1), and the attack length is one month (with 1% interest rate):</p>
<p><code>10 &gt; 1 * 0.01 * (base_amount - 473484) / 35</code> ⇒</p>
<p><code>base_amount &lt; 508484 (sats)</code></p>
<p>In other words, 11 channels together should accumulate for less than 500,000 sats to make amount jamming more efficient than slot jamming a 0-bucketed channel.</p>
<p><strong>These examples demonstrate that for a large number of small/medium-capacity channels, the 0-bucket policy forces the attacker to use amount jamming.</strong></p>
<h3 id="the-cost-of-slot-jamming-a-bucketed-channel"><a class="header" href="#the-cost-of-slot-jamming-a-bucketed-channel">The cost of slot jamming a bucketed channel</a></h3>
<p>Let’s first assume three following optimizations are used:</p>
<ul>
<li>the victim uses JIT Transaction Staging to allocate extra 161 slot per bucket;</li>
<li>the victim uses 0-bucket to increase the cost of attacking the first mentioned bucket (and we disregard below-dust payments for now);</li>
<li>the attacker uses looping to reduce the cost by 9x.</li>
</ul>
<p>The cost of attacking the channel in the figure above (according to the formula) would be:</p>
<ul>
<li>(disable payments) below 100,000 sats but above-dust: <code>546 (150 + 161) / 9 = 18,000 sats/month</code></li>
<li>(disable payments) below 1,000,000 sats: <code>100,000 * (150 + 161) / 9 = +3,455,555 sats/month</code></li>
<li>(disable payments) above 1,000,000 sats: <code>1,000,000 * (150 + 161) / 9 = +34,555,555 sats/month</code></li>
</ul>
<p>We omit the general formula here because it is sophisticated and largely depends on the specific bucket organization. Instead, we attempt to build up the intuition based on this concrete example, which demonstrates that, ultimately, <strong>the attack cost with slot bucketing may be on par with amount jamming costs, if optimal bucketing is applied</strong>.</p>
<h2 id="network-wide-attack-cost"><a class="header" href="#network-wide-attack-cost"><strong>Network-wide attack cost</strong></a></h2>
<p>We repeated the experiment from Chapter 2, where we attempted to make LN payments fail by applying different jamming strategies and seeing how much liquidity an attacker has to commit (considering the model from previous section).</p>
<p align="center" width="100%">
    <img width="66%" src="pics/data2_network_wide.png">
</p>
<p>The most efficient strategy we implemented (top-by-amounts) allows for reducing <em>payment_success</em> from ~35% to 3% while locking the amount equal to 20% of the network public amount.</p>
<p>The attack cost thus could be computed as:</p>
<p><code>opportunity_cost = interest_rate * T * 0.2 * network_capacity</code></p>
<p>We do not consider stealing fees as a way to compensate for the attack in this case.</p>
<p><em>Assuming the 1% monthly interest rate and the current public capacity of 3000 BTC, it would cost 3.75 BTC/week to significantly reduce the throughput of the LN.</em></p>
<h2 id="conclusions"><a class="header" href="#conclusions"><strong>Conclusions</strong></a></h2>
<p>In this Chapter, we overviewed several incremental techniques to mitigate channel jamming, among which Slot Bucketing is the most promising.</p>
<p><strong>Slot</strong> <strong>Bucketing</strong> increases the bar of jamming substantial amounts of the LN. This measure makes the cost of targeted attack on par with amount jamming cost, and attacking the entire network requires locking 20-30% of the network capacity. The disadvantage is making it even cheaper to jam low-value payments, which may raise substantial concerns.</p>
<p><strong>0-bucket policy</strong> is a special case of this defense, achieving the same goal in a limited way, but without negative consequences.</p>
<p>In the next Chapters, we will overview other, more fundamental solutions, and see whether their deployment could be justified.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="2-costs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="4-design_space.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="2-costs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="4-design_space.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
